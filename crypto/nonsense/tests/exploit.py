#!/usr/bin/env python3

from pwn import *
import re

# Run from parent directory.
p = process('./server.py')
match = re.compile("Encrypted flag: ([0-9a-f]+)").search(p.readline().decode())
enc_flag = bytes.fromhex(match.group(1))

def xor(a, b):
    return bytes([x ^ y for x, y in zip(a, b)])

flag = b""
for i in range(16, len(enc_flag), 16):
    nonce = enc_flag[i-16:i]

    if i > 16:
        nonce = xor(nonce, flag[i-32:i-16])

    message = b"\0" * 16

    print(p.recvuntil("What message would you like to encrypt? "))
    print(message.hex())
    p.sendline(message.hex())
    print(p.recvuntil("Nonce? "))
    print(nonce.hex())
    p.sendline(nonce.hex())

    match = re.compile("Your message, encrypted: ([0-9a-f]{64})").search(p.recvline().decode())
    ct = bytes.fromhex(match.group(1))[16:]

    flag = flag + xor(enc_flag[i:i+16], ct)

p.close()

print(flag)
